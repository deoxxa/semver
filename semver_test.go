package semver

import (
	"fmt"
	"testing"

	"github.com/stretchr/testify/assert"
)

func TestVersionParser(t *testing.T) {
	a := assert.New(t)

	v, err := ParseVersion("1.2.3-a.b+x.y.z")
	a.NoError(err)

	a.Equal(1, v.Major)
	a.Equal(2, v.Minor)
	a.Equal(3, v.Patch)

	a.Len(v.Prerelease, 2)
	a.Equal(v.Prerelease[0], "a")
	a.Equal(v.Prerelease[1], "b")

	a.Len(v.Build, 3)
	a.Equal(v.Build[0], "x")
	a.Equal(v.Build[1], "y")
	a.Equal(v.Build[2], "z")
}

func TestVersionComparison(t *testing.T) {
	a := assert.New(t)

	pairs := [][2]string{
		{"0.0.0", "0.0.0-foo"},
		{"0.0.1", "0.0.0"},
		{"1.0.0", "0.9.9"},
		{"0.10.0", "0.9.0"},
		{"0.99.0", "0.10.0"},
		{"2.0.0", "1.2.3"},
		{"v0.0.0", "0.0.0-foo"},
		{"v0.0.1", "0.0.0"},
		{"v1.0.0", "0.9.9"},
		{"v0.10.0", "0.9.0"},
		{"v0.99.0", "0.10.0"},
		{"v2.0.0", "1.2.3"},
		{"0.0.0", "v0.0.0-foo"},
		{"0.0.1", "v0.0.0"},
		{"1.0.0", "v0.9.9"},
		{"0.10.0", "v0.9.0"},
		{"0.99.0", "v0.10.0"},
		{"2.0.0", "v1.2.3"},
		{"1.2.3", "1.2.3-asdf"},
		{"1.2.3", "1.2.3-4"},
		{"1.2.3", "1.2.3-4-foo"},
		{"1.2.3-5-foo", "1.2.3-5"},
		{"1.2.3-5", "1.2.3-4"},
		{"1.2.3-5-foo", "1.2.3-5-Foo"},
		{"3.0.0", "2.7.2+asdf"},
		{"1.2.3-a.10", "1.2.3-a.5"},
		{"1.2.3-a.b", "1.2.3-a.5"},
		{"1.2.3-a.b", "1.2.3-a"},
		{"1.2.3-a.b.c.10.d.5", "1.2.3-a.b.c.5.d.100"},
		{"1.2.3-r2", "1.2.3-r100"},
		{"1.2.3-r100", "1.2.3-R2"},
	}

	for i, p := range pairs {
		v1, err := ParseVersion(p[0])
		a.NoError(err, fmt.Sprintf("[%d] %s", i, p[0]))
		a.NotNil(v1, fmt.Sprintf("[%d] %s", i, p[0]))

		v2, err := ParseVersion(p[1])
		a.NoError(err, fmt.Sprintf("[%d] %s", i, p[1]))
		a.NotNil(v2, fmt.Sprintf("[%d] %s", i, p[1]))

		a.True(v1.GreaterThan(v2), fmt.Sprintf("%s > %s", p[0], p[1]))
		a.True(v2.LessThan(v1), fmt.Sprintf("%s < %s", p[1], p[0]))
		a.False(v1.LessThan(v2), fmt.Sprintf("%s < %s", p[0], p[1]))
		a.False(v2.GreaterThan(v1), fmt.Sprintf("%s > %s", p[1], p[0]))
	}
}

func TestRangeParser(t *testing.T) {
	a := assert.New(t)

	pairs := [][2]string{
		{"1.0.0 - 2.0.0", ">=1.0.0 <=2.0.0"},
		{"1.0.0", "1.0.0"},
		{">=*", ">=0.0.0"},
		{"", ""},
		{"*", ">=0.0.0"},
		{"*", ">=0.0.0"},
		{">=1.0.0", ">=1.0.0"},
		{">1.0.0", ">1.0.0"},
		{"<=2.0.0", "<=2.0.0"},
		{"1", ">=1.0.0 <2.0.0"},
		{"<=2.0.0", "<=2.0.0"},
		{"<=2.0.0", "<=2.0.0"},
		{"<2.0.0", "<2.0.0"},
		{"<2.0.0", "<2.0.0"},
		{">= 1.0.0", ">=1.0.0"},
		{">=  1.0.0", ">=1.0.0"},
		{">=   1.0.0", ">=1.0.0"},
		{"> 1.0.0", ">1.0.0"},
		{">  1.0.0", ">1.0.0"},
		{"<=   2.0.0", "<=2.0.0"},
		{"<= 2.0.0", "<=2.0.0"},
		{"<=  2.0.0", "<=2.0.0"},
		{"<    2.0.0", "<2.0.0"},
		{"<	2.0.0", "<2.0.0"},
		{">=0.1.97", ">=0.1.97"},
		{">=0.1.97", ">=0.1.97"},
		{"0.1.20 || 1.2.4", "0.1.20 || 1.2.4"},
		{">=0.2.3 || <0.0.1", ">=0.2.3 || <0.0.1"},
		{">=0.2.3 || <0.0.1", ">=0.2.3 || <0.0.1"},
		{">=0.2.3 || <0.0.1", ">=0.2.3 || <0.0.1"},
		{"2.x.x", ">=2.0.0 <3.0.0"},
		{"1.2.x", ">=1.2.0 <1.3.0"},
		{"1.2.x || 2.x", ">=1.2.0 <1.3.0 || >=2.0.0 <3.0.0"},
		{"1.2.x || 2.x", ">=1.2.0 <1.3.0 || >=2.0.0 <3.0.0"},
		{"x", ">=0.0.0"},
		{"2.*.*", ">=2.0.0 <3.0.0"},
		{"1.2.*", ">=1.2.0 <1.3.0"},
		{"1.2.* || 2.*", ">=1.2.0 <1.3.0 || >=2.0.0 <3.0.0"},
		{"*", ">=0.0.0"},
		{"2", ">=2.0.0 <3.0.0"},
		{"2.3", ">=2.3.0 <2.4.0"},
		{"~2.4", ">=2.4.0 <2.5.0"},
		{"~2.4", ">=2.4.0 <2.5.0"},
		{"~1", ">=1.0.0 <2.0.0"},
		{"~1.0", ">=1.0.0 <1.1.0"},
		{"~ 1.0", ">=1.0.0 <1.1.0"},
		{"^0", ">=0.0.0 <1.0.0"},
		{"^ 1", ">=1.0.0 <2.0.0"},
		{"^0.1", ">=0.1.0 <0.2.0"},
		{"^1.0", ">=1.0.0 <2.0.0"},
		{"^1.2", ">=1.2.0 <2.0.0"},
		{"^0.0.1", ">=0.0.1 <0.0.2"},
		{"^0.0.1-beta", ">=0.0.1-beta <0.0.2"},
		{"^0.1.2", ">=0.1.2 <0.2.0"},
		{"^1.2.3", ">=1.2.3 <2.0.0"},
		{"^1.2.3-beta.4", ">=1.2.3-beta.4 <2.0.0"},
		{"<1", "<1.0.0"},
		{"< 1", "<1.0.0"},
		{">=1", ">=1.0.0"},
		{">= 1", ">=1.0.0"},
		{"<1.2", "<1.2.0"},
		{"< 1.2", "<1.2.0"},
		{"1", ">=1.0.0 <2.0.0"},
	}

	for i, p := range pairs {
		r, err := ParseRange(p[0])
		a.NoError(err, fmt.Sprintf("[%d] %s", i, p[0]))
		a.NotNil(r, fmt.Sprintf("[%d] %s", i, p[0]))

		a.Equal(p[1], r.String(), fmt.Sprintf("[%d] %s : %s", i, p[0], p[1]))
	}
}

func TestPositiveMatch(t *testing.T) {
	a := assert.New(t)

	pairs := [][2]string{
		{"1.0.0 - 2.0.0", "1.2.3"},
		{"^1.2.3+build", "1.2.3"},
		{"^1.2.3+build", "1.3.0"},
		{"1.2.3-pre+asdf - 2.4.3-pre+asdf", "1.2.3"},
		{"1.2.3-pre+asdf - 2.4.3-pre+asdf", "1.2.3-pre.2"},
		{"1.2.3-pre+asdf - 2.4.3-pre+asdf", "2.4.3-alpha"},
		{"1.2.3+asdf - 2.4.3+asdf", "1.2.3"},
		{"1.0.0", "1.0.0"},
		{">=*", "0.2.4"},
		{"", "1.0.0"},
		{"*", "1.2.3"},
		{">=1.0.0", "1.0.0"},
		{">=1.0.0", "1.0.1"},
		{">=1.0.0", "1.1.0"},
		{">1.0.0", "1.0.1"},
		{">1.0.0", "1.1.0"},
		{"<=2.0.0", "2.0.0"},
		{"<=2.0.0", "1.9999.9999"},
		{"<=2.0.0", "0.2.9"},
		{"<2.0.0", "1.9999.9999"},
		{"<2.0.0", "0.2.9"},
		{">= 1.0.0", "1.0.0"},
		{">=  1.0.0", "1.0.1"},
		{">=   1.0.0", "1.1.0"},
		{"> 1.0.0", "1.0.1"},
		{">  1.0.0", "1.1.0"},
		{"<=   2.0.0", "2.0.0"},
		{"<= 2.0.0", "1.9999.9999"},
		{"<=  2.0.0", "0.2.9"},
		{"<    2.0.0", "1.9999.9999"},
		{"<\t2.0.0", "0.2.9"},
		{">=0.1.97", "0.1.97"},
		{"0.1.20 || 1.2.4", "1.2.4"},
		{">=0.2.3 || <0.0.1", "0.0.0"},
		{">=0.2.3 || <0.0.1", "0.2.3"},
		{">=0.2.3 || <0.0.1", "0.2.4"},
		{"2.x.x", "2.1.3"},
		{"1.2.x", "1.2.3"},
		{"1.2.x || 2.x", "2.1.3"},
		{"1.2.x || 2.x", "1.2.3"},
		{"x", "1.2.3"},
		{"2.*.*", "2.1.3"},
		{"1.2.*", "1.2.3"},
		{"1.2.* || 2.*", "2.1.3"},
		{"1.2.* || 2.*", "1.2.3"},
		{"*", "1.2.3"},
		{"2", "2.1.2"},
		{"2.3", "2.3.1"},
		{"~2.4", "2.4.0"}, // >=2.4.0 <2.5.0
		{"~2.4", "2.4.5"},
		{"~1", "1.2.3"},   // >=1.0.0 <2.0.0
		{"~1.0", "1.0.2"}, // >=1.0.0 <1.1.0,
		{"~ 1.0", "1.0.2"},
		{"~ 1.0.3", "1.0.12"},
		{">=1", "1.0.0"},
		{">= 1", "1.0.0"},
		{"<1.2", "1.1.1"},
		{"< 1.2", "1.1.1"},
		{"~v0.5.4-pre", "0.5.5"},
		{"~v0.5.4-pre", "0.5.4"},
		{"=0.7.x", "0.7.2"},
		{"<=0.7.x", "0.7.2"},
		{">=0.7.x", "0.7.2"},
		{"<=0.7.x", "0.6.2"},
		{"~1.2.1 >=1.2.3", "1.2.3"},
		{"~1.2.1 =1.2.3", "1.2.3"},
		{"~1.2.1 1.2.3", "1.2.3"},
		{"~1.2.1 >=1.2.3 1.2.3", "1.2.3"},
		{"~1.2.1 1.2.3 >=1.2.3", "1.2.3"},
		{"~1.2.1 1.2.3", "1.2.3"},
		{">=1.2.1 1.2.3", "1.2.3"},
		{"1.2.3 >=1.2.1", "1.2.3"},
		{">=1.2.3 >=1.2.1", "1.2.3"},
		{">=1.2.1 >=1.2.3", "1.2.3"},
		{">=1.2", "1.2.8"},
		{"^1.2.3", "1.8.1"},
		{"^0.1.2", "0.1.2"},
		{"^0.1", "0.1.2"},
		{"^1.2", "1.4.2"},
		{"^1.2 ^1", "1.4.2"},
		{"^1.2.3-alpha", "1.2.3-pre"},
		{"^1.2.0-alpha", "1.2.0-pre"},
		{"^0.0.1-alpha", "0.0.1-beta"},
	}

	for i, p := range pairs {
		v, err := ParseVersion(p[1])
		a.NoError(err, fmt.Sprintf("[%d] %s", i, p[1]))
		a.NotNil(v, fmt.Sprintf("[%d] %s", i, p[1]))

		r, err := ParseRange(p[0])
		a.NoError(err, fmt.Sprintf("[%d] %s", i, p[0]))
		a.NotNil(r, fmt.Sprintf("[%d] %s", i, p[0]))
		a.True(r.SatisfiedBy(v), fmt.Sprintf("[%d] %s : %s", i, p[0], p[1]))
	}
}

func TestNegativeMatch(t *testing.T) {
	a := assert.New(t)

	pairs := [][2]string{
		{"1.0.0 - 2.0.0", "2.2.3"},
		{"1.2.3+asdf - 2.4.3+asdf", "1.2.3-pre.2"},
		{"1.2.3+asdf - 2.4.3+asdf", "2.4.3-alpha"},
		{"^1.2.3+build", "2.0.0"},
		{"^1.2.3+build", "1.2.0"},
		{"^1.2.3", "1.2.3-pre"},
		{"^1.2", "1.2.0-pre"},
		{">1.2", "1.3.0-beta"},
		{"<=1.2.3", "1.2.3-beta"},
		{"^1.2.3", "1.2.3-beta"},
		{"=0.7.x", "0.7.0-asdf"},
		{">=0.7.x", "0.7.0-asdf"},
		{"1.0.0", "1.0.1"},
		{">=1.0.0", "0.0.0"},
		{">=1.0.0", "0.0.1"},
		{">=1.0.0", "0.1.0"},
		{">1.0.0", "0.0.1"},
		{">1.0.0", "0.1.0"},
		{"<=2.0.0", "3.0.0"},
		{"<=2.0.0", "2.9999.9999"},
		{"<=2.0.0", "2.2.9"},
		{"<2.0.0", "2.9999.9999"},
		{"<2.0.0", "2.2.9"},
		{">=0.1.97", "0.1.93"},
		{"0.1.20 || 1.2.4", "1.2.3"},
		{">=0.2.3 || <0.0.1", "0.0.3"},
		{">=0.2.3 || <0.0.1", "0.2.2"},
		{"2.x.x", "1.1.3"},
		{"2.x.x", "3.1.3"},
		{"1.2.x", "1.3.3"},
		{"1.2.x || 2.x", "3.1.3"},
		{"1.2.x || 2.x", "1.1.3"},
		{"2.*.*", "1.1.3"},
		{"2.*.*", "3.1.3"},
		{"1.2.*", "1.3.3"},
		{"1.2.* || 2.*", "3.1.3"},
		{"1.2.* || 2.*", "1.1.3"},
		{"2", "1.1.2"},
		{"2.3", "2.4.1"},
		{"~2.4", "2.5.0"}, // >=2.4.0 <2.5.0
		{"~2.4", "2.3.9"},
		{"~1", "0.2.3"},   // >=1.0.0 <2.0.0
		{"~1.0", "1.1.0"}, // >=1.0.0 <1.1.0
		{"<1", "1.0.0"},
		{">=1.2", "1.1.1"},
		{"~v0.5.4-beta", "0.5.4-alpha"},
		{"=0.7.x", "0.8.2"},
		{">=0.7.x", "0.6.2"},
		{"<0.7.x", "0.7.2"},
		{"<1.2.3", "1.2.3-beta"},
		{"=1.2.3", "1.2.3-beta"},
		{">1.2", "1.2.8"},
		{"^1.2.3", "2.0.0-alpha"},
		{"^1.2.3", "1.2.2"},
		{"^1.2", "1.1.9"},
	}

	for i, p := range pairs {
		v, err := ParseVersion(p[1])
		a.NoError(err, fmt.Sprintf("[%d] %s", i, p[1]))
		a.NotNil(v, fmt.Sprintf("[%d] %s", i, p[1]))

		r, err := ParseRange(p[0])
		a.NoError(err, fmt.Sprintf("[%d] %s", i, p[0]))
		a.NotNil(r, fmt.Sprintf("[%d] %s", i, p[0]))
		a.False(r.SatisfiedBy(v), fmt.Sprintf("[%d] %s : %s", i, p[0], p[1]))
	}
}
